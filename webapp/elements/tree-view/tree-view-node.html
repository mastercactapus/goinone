<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../context-menu/context-menu.html">

<dom-module id="tree-view-node">

<template>
    <style>
      .tree-node {
        margin-left: 24px;
        cursor: default;
        font-family: monospace;
      }
      .item-wrapper {
      	position: relative;
      }
    </style>

	<div class="tree-node">
		<iron-ajax auto url="{{statPath}}" last-response="{{stat}}"></iron-ajax>

		<div class="item-wrapper" id="node">
			<iron-icon icon="{{iconArrow}}"></iron-icon><iron-icon icon="{{icon}}"></iron-icon><span id="self">{{name}}</span>
			<paper-ripple></paper-ripple>
		</div>
		<context-menu id="menu" items="{{menuItems}}" on-context-action="handleContextAction"></context-menu>

		<template is="dom-if" if="{{IsDir}}">
			<template restamp="true" is="dom-if" if="{{expanded}}">
				<iron-ajax auto url="{{readPath}}" last-response="{{childrenRaw}}"></iron-ajax>
				<template is="dom-repeat" items="{{children}}">
					<tree-view-node
						name="{{item.Name}}"
						stat="{{item}}"
						path="{{computeChildPath(item)}}">
					</tree-view-node>
				</template>
			</template>
		</template>
	</div>
</template>

<script>
	Polymer({
		is: "tree-view-node",
		listeners: {
			"node.tap": "selfTap",
			"node.contextmenu": "handleMenu",
		},
		properties: {
			children: {
				value: [],
				computed: 'computeChildren(childrenRaw)',
			},
			IsDir: {
				type: Boolean,
				value: false,
				computed: 'computeIsDir(stat)',
			},
			statPath: {
				type: String,
				computed: 'computeStatPath(path)',
			},
			readPath: {
				type: String,
				computed: 'computeReadPath(path)',
			},
			icon: {
				computed: 'computeIcon(IsDir, expanded)',
			},
			iconArrow: {
				computed: 'computeIconArrow(IsDir, expanded)',
			},
			menuItems: {
				computed: 'computeMenuItems(IsDir)',
			},
			expanded: {
				type: Boolean,
				value: false,
			},
			path: {
				type: String,
				value: "/"
			},
			showContext: {
				type: Boolean,
				value: false,
			}
		},
		computeMenuItems: function(isDir) {
			if (isDir) {
				return ["New File...", "Rename...", "-", "New Folder...", "Delete Folder", "Find in Folder..."];
			} else {
				return ["Rename...", "Delete File"];
			}
		},
		computeIsDir: function(stat) {
			return !!stat.IsDir;
		},
		computeStatPath: function(path) {
			return "/api/fs" + path + "?stat=1";
		},
		computeReadPath: function(path) {
			return "/api/fs" + path;
		},
		computeChildPath: function(child) {
			return this.path.replace(/\/$/,"") + "/" + child.Name;
		},
		computeChildren: function(childrenRaw) {
			var dirs = [];
			var files = [];
			childrenRaw.forEach(function(item){
				if (item.IsDir) {
					dirs.push(item);
				} else {
					files.push(item);
				}
			});
			return dirs.concat(files);
		},
		computeIcon: function(isDir, expanded) {
			if (expanded) {
				return "folder-open";
			}
			if (!isDir) {
				return "editor:insert-drive-file";
			}
			return "folder";
		},
		computeIconArrow: function(isDir, expanded) {
			if (expanded) {
				return "hardware:keyboard-arrow-down";
			}
			if (!isDir) {
				return "";
			}
			return "hardware:keyboard-arrow-right";
		},
		selfTap: function(e) {
			e.stopPropagation();
			if (!this.stat || !this.stat.IsDir) {
				if (this.stat) {
					this.fire("file-selected", {filePath: this.path});
				}
				return;
			};
			this.expanded = !this.expanded;
		},
		handleMenu: function(e) {
			this.$.menu.show(e.x, e.y);
			e.preventDefault();
			e.stopPropagation();
		},
		handleContextAction: function(e){
			switch (e.detail.value) {
				case "New File...":
				console.log("new file!");
				break;
			}
		}
	});

</script>

</dom-module>